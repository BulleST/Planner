<form #form="ngForm" (ngSubmit)="send(form)" class="needs-validation">
    <div class="card card-body mb-2">
        <div class="form-row">
            <div class="form-group col-sm-12">
                <label for="carteiraSetup" class="h6">Carteira: <span class="text-danger">*</span></label>
                <p-dropdown
                [options]="carteirasSetup"
                id="carteiraSetup"
                name="carteiraSetup" 
                #carteiraSetup="ngModel"
                [(ngModel)]="_carteiraSetup" 
                [editable]="true" 
                optionLabel="nome"
                [filter]="true" 
                filterBy="nome" 
                [showClear]="true"
                class="form-control"
                (ngModelChange)="carteiraSetupChange(carteiraSetup)" 
                 placeholder="Selecione uma carteira ou digite para cadastrar">
                
                 <ng-template pTemplate="selectedItem">
                    <div class="country-item country-item-value" *ngIf="_carteiraSetup">
                        <div>{{_carteiraSetup.nome}}</div>
                    </div>
                </ng-template>
                <ng-template let-country pTemplate="item">
                    <div class="country-item">
                        <div>{{country.nome}}</div>
                    </div>
                </ng-template>
                </p-dropdown>
            </div>
        </div>
    </div>
    <div class="form-row chart-container card card-body">
        <div class="d-flex">
            <div>
                <h6>Divisão de Risco: <span class="text-danger">*</span></h6>
                <p class="text-danger" *ngIf="maxPercentual < 100"><small>Clique para editar</small></p>
                <a title="Adicionar risco" *ngIf="maxPercentual == 100" [routerLink]="['risco']" class="btn btn-small btn-primary px-2 ml-auto mt-1 mb-2">
                    <small> Adicionar </small>
                </a>
            </div>
            <div class="ml-auto data-view" [class.right]="view == false">
                <button type="button" class="btn" title="Ver gráfico" (click)="view = true">
                    <fa-icon [icon]="faChartSimple"></fa-icon>
                </button>
                <button type="button" class="btn" title="Ver tabela" (click)="view = false">
                    <fa-icon [icon]="faTable"></fa-icon>
                </button>
            </div>
        </div>
        <div *ngIf="view">
            <p-chart type="verticalBar" [options]="options" [data]="data" [width]="chartWidth" height="100px" (onDataSelect)="selectData($event)"></p-chart>
        </div>
        <div *ngIf="!view" class="content">
            <app-list-shared [createLink]="[]"
                             [list]="objeto.carteiraRiscoRel"
                             [paginator]="false"
                             [filterLink]="false"
                             [filterTable]="false"
                             [sortTable]="true"
                             [menuTable]="false"
                             [canCreate]="false"
                             [selectable]="false"
                             [columns]="carteiraRiscoColumns"
                             [tableLinks]="[]"></app-list-shared>
            <div>
                <p class="ml-auto text-right">
                    <strong>Total: </strong> {{totalPercentage}}%
                </p>
            </div>
        </div>
    </div>
    <div class="card mt-2">
        <div class="card-body bg-white ">
            <h6>Produtos: <span class="text-danger">*</span></h6>
            <div class="form-row">
                <div class="form-group col-lg-4 col-md-4 col-sm-12 mt-2">
                    <label for="produto">Produto: <span class="text-danger">*</span></label>
                    <select
                            class="form-control"
                            id="produto"
                            name="produto"
                            #_produto="ngModel"
                            [(ngModel)]="produto"
                            (change)="tributacao = undefined">
                        <option [ngValue]="undefined">Selecione</option>
                        <option [ngValue]="item" *ngFor="let item of produtos">{{ item.descricao }}</option>
                    </select>
                </div>
                <div class="form-group col-lg-4 col-md-4 col-sm-12 mt-2">
                    <label for="tributacao">Tributação: <span class="text-danger">*</span></label>
                    <select
                            class="form-control"
                            id="tributacao"
                            name="tributacao"
                            #_tributacao="ngModel"
                            [(ngModel)]="tributacao">
                        <option [ngValue]="undefined">Selecione o produto</option>
                        <option [ngValue]="item" *ngFor="let item of (produto != undefined ? produto.tributacao : [])">{{ item.descricao }}</option>
                    </select>
                </div>
                <div class="form-group mt-2 px-2" style="max-width: 200px;"
                     [class.fade-out-left]="!tributacao"
                     [class.fade-in-right]="tributacao">
                    <label for="aliquota">Alíquota: <span class="text-danger">*</span></label>
                    <input type="text"
                           class="form-control"
                           id="aliquota"
                           name="aliquota"
                           mask="separator"
                           thousandSeparator="."
                           decimalMarker=","
                           suffix="%"
                           #aliquota
                           [value]="tributacao != undefined ? tributacao!.aliquota + ' %': ''"
                           readonly>
                </div>
                <button type="button" class="btn btn-grey d-flex ml-auto align-self-center mt-2" (click)="adicionarProduto()">Adicionar</button>
            </div>
        <div *ngIf="objeto.carteiraProdutoRel.length > 0">
            <h6 class="mt-3 mb-2">Itens selecionados</h6>
            <div class="overflow-x-auto w-100">
                <table class="table table-striped table-borderless">
                    <thead>
                        <tr>
                            <th class="bg-dark text-white font-weight-normal"></th>
                            <th class="bg-dark text-white font-weight-normal">Id</th>
                            <th class="bg-dark text-white font-weight-normal">Produto</th>
                            <th class="bg-dark text-white font-weight-normal">Tributação</th>
                            <th class="bg-dark text-white font-weight-normal">Alíquota</th>
                            <th class="bg-dark text-white font-weight-normal"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of objeto.carteiraProdutoRel">
                            <td></td>
                            <td>{{item.id}}</td>
                            <td>{{item.produtoTributacaoRel.produto.descricao}}</td>
                            <td>{{item.produtoTributacaoRel.tributacao.descricao}}</td>
                            <td>{{item.produtoTributacaoRel.tributacao.aliquota | mask : 'separator' : '.' }}%</td>
                            <td>
                                <button type="button" class="btn btn-small btn-trash ml-auto d-block px-0 text-dark" (click)="removeItem(item.id)">
                                    <fa-icon [icon]="faTrashAlt"></fa-icon>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        </div>
    </div>
    <div class="d-flex p-0 mt-3">
        <div *ngIf="erro || form.invalid" class="m-0">
            <p class="text-red" *ngFor="let err of erro">{{err}}</p>
            <p *ngIf="form.invalid && erro.length == 0" class="text-red">Preencha todos os campos obrigatórios (*) corretamente para salvar</p>
        </div>
        <button class="btn btn-primary mr-0 ml-auto" [disabled]="form.invalid || loading">
            <span *ngIf="loading" class="spinner-border spinner-border-sm mr-1"></span> Salvar </button>
    </div>
</form>
<ng-template #campoObrigatorio>
    <div class="py-3 px-4"> Este campo é obrigatório </div>
</ng-template>