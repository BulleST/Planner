<form #form="ngForm" (ngSubmit)="send(form)" class="needs-validation">
    <div class="d-flex flex-wrap align-items-stretch mb-2">
        <div class="col-lg-9 col-md-8 col-sm-12 pl-0 pr-1">
            <div class="card card-body">
                <div class="form-row">
                    <div class="form-group col-sm-12">
                        <label for="carteiraSetup" class="h6">Carteira: <span class="text-danger">*</span></label>
                        <div>
                            <input type="text" 
                                class="form-control my-1" 
                                name="nome" 
                                id="nome" 
                                #nome="ngModel" 
                                [(ngModel)]="objeto.nome"
                                [readonly]="isEditPage"
                                placeholder="Digite para cadastrar nova carteira">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-4 col-sm-12 px-0 d-md-block d-sm-none">
            <div class="card card-body h-100">
                <h6 class="mt-auto font-weight-light">Total Risco</h6>
                <h2 class="">{{percentualTotalRisco | currency : 'BRL' : '' : '1.2-2'}}%</h2>
            </div>
        </div>
    </div>
    <div class="form-row chart-container card card-body">
        <div class="d-flex">
            <div>
                <h6>Divisão de Risco: <span class="text-danger">*</span></h6>
                <p class="text-danger"><small>Clique para editar</small></p>
                <div class="d-flex ml-auto mt-1 mb-2">
                    <a title="Adicionar risco" *ngIf="percentualDisponivelRisco < 100" [routerLink]="['risco']" class="btn btn-small btn-primary ml-1 px-2">
                        <small> Adicionar </small>
                    </a>
                    <div *ngIf="selectedRisco">
                        <button type="button" class="btn btn-small btn-dark px-2 mx-1" (click)="excluirRisco(selectedRisco)">
                            <!-- <fa-icon [icon]="faTrashAlt"></fa-icon> -->
                            <small>Excluir</small>
                        </button>
                        <button type="button" class="btn btn-small btn-grey px-2" (click)="editarRisco(selectedRisco)">
                            <!-- <fa-icon [icon]="faEdit"></fa-icon> -->
                            <small>Editar</small>
                        </button>
                    </div>
                </div>
            </div>
            <!-- <div class="ml-auto data-view" [class.right]="viewRisco == false">
                <button type="button" class="btn" title="Ver gráfico" (click)="viewRisco = true">
                    <fa-icon [icon]="faChartSimple"></fa-icon>
                </button>
                <button type="button" class="btn" title="Ver tabela" (click)="viewRisco = false">
                    <fa-icon [icon]="faTable"></fa-icon>
                </button>
            </div> -->
        </div>
        <div>
            <p-chart type="verticalBar" [options]="optionsRisco" [data]="dataRisco" [width]="chartWidth" height="100px" (onDataSelect)="selectData($event)"></p-chart>
        </div>
        <!-- <div *ngIf="!viewRisco" class="content">
            <app-list-shared [createLink]="[]"
                             [list]="objeto.carteiraRiscoRel"
                             [paginator]="false"
                             [filterLink]="false"
                             [filterTable]="false"
                             [sortTable]="true"
                             [menuTable]="false"
                             [canCreate]="false"
                             [selectable]="true"
                             [columns]="carteiraRiscoColumns"
                             [tableLinks]="[]"></app-list-shared>
            <div>
                <p class="ml-auto text-right">
                    <strong>Total: </strong> {{percentualTotalRisco | currency : 'BRL' : '' : '1.2-2' }}%
                </p>
            </div>
        </div> -->
    </div>
    <div class="card mt-2">
        <div class="card-body bg-white">
            <div class="d-flex align-items-center px-2">
                <h6>Produtos: <span class="text-danger">*</span></h6>
                <!-- <div class="ml-auto data-view" [class.right]="viewProduto == false">
                    <button type="button" class="btn" title="Ver gráfico" (click)="viewProduto = true">
                        <fa-icon [icon]="faChartSimple"></fa-icon>
                    </button>
                    <button type="button" class="btn" title="Ver tabela" (click)="viewProduto = false">
                        <fa-icon [icon]="faTable"></fa-icon>
                    </button>
                </div> -->
            </div>
            <!-- <div class="form-row">
                <div class="form-group col-lg-4 col-md-4 col-sm-12">
                    <label for="tipoRisco">Escolher Risco:</label>
                    <select
                        class="form-control"
                        id="tipoRisco"
                        name="tipoRisco"
                        #_tipoRisco="ngModel"
                        [(ngModel)]="tipoRisco"
                        (change)="tipoRiscoChange()">
                        <option [ngValue]="undefined">Selecione</option>
                        <option [ngValue]="item" *ngFor="let item of riscos">{{ item.nome }}</option>
                    </select>
                </div>
            </div> -->
            <div class="form-row">
                <div class="form-group col-lg-3 col-md-3 col-sm-12 mt-2">
                    <label for="produto">Produto: <span class="text-danger">*</span></label>
                    <select
                            class="form-control"
                            id="produto"
                            name="produto"
                            #_produto="ngModel"
                            [(ngModel)]="produto"
                            [disabled]="selectedRisco == undefined"
                            (change)="tributacao = undefined">
                        <option [ngValue]="undefined">Selecione</option>
                        <option [ngValue]="item" *ngFor="let item of produtos">{{ item.descricao }}</option>
                    </select>
                </div>
                <div class="form-group col-lg-3 col-md-3 col-sm-12 mt-2">
                    <label for="tributacao">Tributação: <span class="text-danger">*</span></label>
                    <select
                            class="form-control"
                            id="tributacao"
                            name="tributacao"
                            #_tributacao="ngModel"
                            [disabled]="selectedRisco == undefined"
                            [(ngModel)]="tributacao">
                        <option [ngValue]="undefined">Selecione o produto</option>
                        <option [ngValue]="item" *ngFor="let item of (produto != undefined ? produto.tributacao : [])">{{ item.descricao }}</option>
                    </select>
                </div>
                <div class="form-group col-lg-2 col-md-2 col-sm-12 mt-2 px-2"
                     [class.fade-out-left]="!tributacao"
                     [class.fade-in-right]="tributacao"
                     [class.d-none]="!tributacao">
                    <label for="aliquota">Alíquota: <span class="text-danger">*</span></label>
                    <input type="text"
                           class="form-control"
                           id="aliquota"
                           name="aliquota"
                           mask="separator"
                           thousandSeparator="."
                           decimalMarker=","
                           suffix="%"
                           #aliquota
                           [value]="tributacao != undefined ? tributacao!.aliquota + ' %': ''"
                           readonly>
                </div>
                <div class="form-group  col-sm-12 mt-2 px-2"
                        [ngClass]="!tributacao ? 'col-lg-4 col-md-4' : 'col-lg-2 col-md-2'">
                    <label for="percentual">Percentual: <span class="text-danger">*</span></label>
                    <input type="text"
                           class="form-control"
                           id="percentual"
                           name="percentual"
                           mask="separator"
                           thousandSeparator="."
                           decimalMarker=","
                           suffix="%"
                           #_percentual="ngModel"
                           [max]="percentualDisponivelProduto"
                           [placeholder]="selectedRisco != undefined ? 'Máximo de '+ percentualDisponivelProduto + '%' : ''"
                           [disabled]="selectedRisco == undefined"
                           [(ngModel)]="percentual">
                </div>
                <div class="form-group col-lg-2 col-md-2 col-sm-12 align-itens-end d-flex">
                    <button type="button" class="btn btn-grey mt-auto" (click)="adicionarProduto()">Adicionar</button>
                </div>
            </div>
            <div>
                <p class="text-danger col-sm-12" *ngIf="selectedRisco == undefined">Selecione um risco para continuar.</p>
                <p class="text-danger col-sm-12" *ngIf=" selectedRisco != undefined && produtos.length == 0">Nenhum produto com esse risco está cadastrado.</p>
            </div>
            <div *ngIf="objeto.carteiraProdutoRel.length > 0" class="px-2">
                <p class="mt-3 mb-1">Itens selecionados</p>
                <div class="overflow-x-auto w-100">
                    <table class="table table-striped table-borderless">
                        <thead>
                            <tr>
                                <th class="bg-dark text-white font-weight-normal"></th>
                                <th class="bg-dark text-white font-weight-normal">Id</th>
                                <th class="bg-dark text-white font-weight-normal">Produto</th>
                                <th class="bg-dark text-white font-weight-normal">Risco</th>
                                <th class="bg-dark text-white font-weight-normal">Tributação</th>
                                <th class="bg-dark text-white font-weight-normal">Alíquota</th>
                                <th class="bg-dark text-white font-weight-normal">Percentual</th>
                                <th class="bg-dark text-white font-weight-normal"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of objeto.carteiraProdutoRel" [class.selected]="item.produtoTributacaoRel.produto.tipoRisco_Id == selectedRisco?.tipoRisco_Id">
                                <td></td>
                                <td>{{item.id }}</td>
                                <td>{{item.produtoTributacaoRel.produto.tipoRisco?.nome}}</td>
                                <td>{{item.produtoTributacaoRel.produto.descricao}}</td>
                                <td>{{item.produtoTributacaoRel.tributacao.descricao}}</td>
                                <td>{{item.produtoTributacaoRel.tributacao.aliquota | mask : 'separator' : '.' }}%</td>
                                <td>{{item.percentual | mask : 'separator' : '.' }}%</td>
                                <td>
                                    <button type="button" class="btn-trash ml-auto d-block px-2 text-dark" (click)="removeProduto(item)">
                                        <fa-icon [icon]="faTrashAlt" class="d-md-none d-sm-block"></fa-icon>
                                        <span class="d-md-block d-sm-none btn btn-dark">Excluir</span>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="d-flex p-0 mt-3">
        <div *ngIf="erro || form.invalid" class="m-0">
            <p class="text-red" *ngFor="let err of erro">{{err}}</p>
            <p *ngIf="form.invalid && erro.length == 0" class="text-red">Preencha todos os campos obrigatórios (*) corretamente para salvar</p>
        </div>
        <button class="btn btn-primary mr-0 ml-auto" [disabled]="form.invalid || loading">
            <span *ngIf="loading" class="spinner-border spinner-border-sm mr-1"></span> Salvar </button>
    </div>
</form>
<ng-template #campoObrigatorio>
    <div class="py-3 px-4"> Este campo é obrigatório </div>
</ng-template>